CREATE TABLE kimia-farma-rna.kf_dataset.task_dataset AS
SELECT 
    x.transaction_id, 
    x.date, 
    x.branch_id, 
    x.branch_name, 
    x.kota, 
    x.provinsi, 
    x.rating_cabang, 
    x.customer_name, 
    x.product_id, 
    x.product_name, 
    x.actual_price, 
    x.discount_percentage, 
    x.persentase_gross_laba, 
    x.nett_sales, 
    x.nett_sales - (x.actual_price * (1 - x.persentase_gross_laba)) AS nett_profit,
    x.rating_transaksi
FROM (
    SELECT 
        a.transaction_id, 
        a.date, 
        a.branch_id, 
        b.branch_name, 
        b.kota, 
        b.provinsi, 
        b.rating AS rating_cabang, 
        a.customer_name, 
        a.product_id, 
        c.product_name, 
        c.price AS actual_price, 
        a.discount_percentage,
        CASE 
            WHEN c.price <= 50000 THEN 0.10
            WHEN c.price > 50000 AND c.price <= 100000 THEN 0.15
            WHEN c.price > 100000 AND c.price <= 300000 THEN 0.20
            WHEN c.price > 300000 AND c.price <= 500000 THEN 0.25
            WHEN c.price > 500000 THEN 0.30
        END AS persentase_gross_laba,
        c.price - (c.price * a.discount_percentage) AS nett_sales,
        a.rating AS rating_transaksi
    FROM 
        kimia-farma-rna.kf_dataset.kf_final_transaction a
    LEFT JOIN 
        kimia-farma-rna.kf_dataset.kf_kantor_cabang b ON a.branch_id = b.branch_id
    LEFT JOIN 
        kimia-farma-rna.kf_dataset.kf_product c ON a.product_id = c.product_id
) x;
